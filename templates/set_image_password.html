{% extends "base.html" %}
{% block content %}
<div class="panel">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Set Image Password for App #{{ app_id }}</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('my_webapps') }}">Back</a>
  </div>

  <div class="row g-4">
    <div class="col-12 col-md-6">
      <label class="form-label">Choose Category</label>
      <select id="category" name="category" class="form-select" required>
        <option value="">-- select category --</option>
        {% for c in categories %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
      <div class="form-text muted">Only images from the selected category are shown below for password selection.</div>

      <div class="mt-3">
        <label class="form-label">Selected Sequence</label>
        <div id="preview" class="sequence-preview"></div>
      </div>

      <div class="mt-3">
        <label class="form-label">Hint (optional)</label>
        <input id="hint" name="hint" class="form-control">
        <div class="form-text muted">This hint will be shown when you click "Forgot Image Password".</div>
      </div>

      <div class="mt-4">
        <button class="btn btn-primary" onclick="saveSequence(event)">Save Image Password</button>
        <button class="btn btn-outline-secondary ms-2" onclick="clearSelection()">Clear</button>
      </div>
    </div>

    <div class="col-12 col-md-6">
      <div id="images-area" class="panel" style="min-height:260px;">
        <div class="muted">Choose a category to load images.</div>
      </div>
    </div>
  </div>

  <!-- hidden form to submit -->
  <form id="hidden-form" method="post" style="display:none;">
    <input type="hidden" name="category" id="hidden-category">
    <input type="hidden" name="sequence" id="hidden-sequence">
    <input type="hidden" name="hint" id="hidden-hint">
  </form>
</div>

<script>
let selected = []; // array of 'category/filename'
const preview = document.getElementById('preview');
const imagesArea = document.getElementById('images-area');

function renderPreview(){
  preview.innerHTML = '';
  selected.forEach((path, idx) => {
    const parts = path.split('/');
    const fname = parts.slice(1).join('/');
    const div = document.createElement('div');
    div.className = 'img-card';
    div.style.width = '60px';
    div.style.height = '60px';
    div.style.padding = '6px';
    div.style.cursor = 'default';
    div.innerHTML = `<div class="order-badge" style="top:6px;left:6px;">${idx+1}</div><img src="/static/images/${parts[0]}/${fname}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
    preview.appendChild(div);
  });
}

function clearSelection(){
  selected = [];
  renderPreview();
  document.querySelectorAll('.img-card').forEach(el => el.classList.remove('img-picked'));
}

async function loadCategory(cat){
  imagesArea.innerHTML = '<div class="muted">Loading imagesâ€¦</div>';
  try {
    const resp = await fetch(`/list-images/${encodeURIComponent(cat)}`);
    const files = await resp.json();
    if (!Array.isArray(files) || files.length === 0){
      imagesArea.innerHTML = `<div class="muted">No images found in static/images/${cat}.</div>`;
      return;
    }

    // build grid
    const grid = document.createElement('div');
    grid.className = 'image-grid';
    files.forEach(fname => {
      const container = document.createElement('div');
      container.className = 'img-card';
      const img = document.createElement('img');
      img.src = `/static/images/${cat}/${fname}`;
      img.alt = fname;
      img.loading = 'lazy';
      // data-path stores category/filename
      container.setAttribute('data-path', `${cat}/${fname}`);
      container.appendChild(img);

      container.addEventListener('click', () => {
        const path = container.getAttribute('data-path');
        const idx = selected.indexOf(path);
        if (idx === -1) {
          selected.push(path);
          container.classList.add('img-picked');
        } else {
          selected.splice(idx,1);
          container.classList.remove('img-picked');
        }
        renderPreview();
      });

      grid.appendChild(container);
    });

    imagesArea.innerHTML = '';
    imagesArea.appendChild(grid);
    // trigger image loaded classes
    imagesArea.querySelectorAll('img').forEach(img => {
      img.addEventListener('load', () => {
        img.closest('.img-card').classList.add('loaded');
      });
      img.addEventListener('error', () => {
        img.closest('.img-card').style.opacity = '.35';
      });
    });
  } catch(e){
    imagesArea.innerHTML = `<div class="text-danger">Failed to load images.</div>`;
    console.error(e);
  }
}

document.getElementById('category').addEventListener('change', (e) => {
  const cat = e.target.value;
  selected = [];
  renderPreview();
  if (!cat) {
    imagesArea.innerHTML = '<div class="muted">Choose a category to load images.</div>';
    return;
  }
  loadCategory(cat);
});

/* Save: validate and post using hidden form */
function saveSequence(e){
  e.preventDefault();
  const cat = document.getElementById('category').value;
  const hintVal = document.getElementById('hint').value || '';
  if (!cat) { alert('Select a category'); return; }
  if (selected.length === 0) { alert('Select at least one image'); return; }

  // set hidden inputs
  document.getElementById('hidden-category').value = cat;
  document.getElementById('hidden-sequence').value = JSON.stringify(selected);
  document.getElementById('hidden-hint').value = hintVal;

  // construct and submit a form to current POST URL
  const form = document.createElement('form');
  form.method = 'POST';
  form.style.display = 'none';
  const f1 = document.createElement('input'); f1.name='category'; f1.value=cat; form.appendChild(f1);
  const f2 = document.createElement('input'); f2.name='sequence'; f2.value=JSON.stringify(selected); form.appendChild(f2);
  const f3 = document.createElement('input'); f3.name='hint'; f3.value=hintVal; form.appendChild(f3);
  document.body.appendChild(form);
  form.submit();
}
</script>
{% endblock %}
